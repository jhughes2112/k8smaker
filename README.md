
# k8smaker
A fully scripted Kubernetes deployment

This is a personal project to make it easier to setup a Kubernetes cluster from scratch, fully ready to launch pods.  It's a fully scripted deployment by way of a couple of Bash scripts that simply and cleanly arranges the prerequisites for K8s, allow for an explicit data drive where `etcd` and `Docker` data are stored.  If you have read many walkthroughs on installing Kubernetes, these are pretty much all those steps and suggestions, smashed into a single script and automated.  Watch this space, as this is very early and under rapid development.

All these scripts are intended to run from the first machine in the k8s cluster, which we'll call `control-node1`.  It sets up an ssh key on initialization and copies it to the other nodes so it can poke in the appropriate script and install.

At least in my case, I have machines that boot to a slow drive and a really fast NVME that I want everything else to run from.  **k8smaker** lets you specify the name of that device and, if found, adds it to the /etc/fstab, mounts it, and maps the /var/lib/etcd and /var/lib/docker folders to live there in subdirectories, so you can also use that space for PV volumes or bind mounts or whatever.  If no device is found, it leaves everything alone.

## Cluster Configuration

 - Kubernetes 1.18.4
 - Ubuntu 18.04LTS
 - Bare metal or AWS EC2
 - etcd and control plane are stacked on control nodes
 -- A smaller machine will suffice to manage the cluster
 -- Setup for HA control cluster, even if you only have one to start with
 - pods run on worker nodes
 -- Use beefy machines for these
 - **Calico** for networking automatically configured to talk to secured etcd
 - **Istio 1.6.3** for ingress and mesh routing

## Some parts run as Root
Tested on Ubuntu 18.04LTS only.  May run on any reasonably vanilla `systemd` based Debian-based Linux.  Do not run these scripts on anything except a newly installed machine.  **Data loss is very possible.**  As with anything you download off the internet, running a script as `root` is dangerous and until it's proven trustworthy, it may destroy anything or everything it touches.  I promise this script doesn't intend to do that, but why should  you trust me?  **Read it over first, and if you see anything you are concerned with, don't run it!**  Even better, fix it and send me a pull request.

## Prerequisites for k8smaker

 - All nodes need to be a `systemd`-based Ubuntu 18.04LTS (or similar Debian distro)
 - All nodes need [OpenSSH](https://linuxize.com/post/how-to-enable-ssh-on-ubuntu-18-04/) installed so `control-node1` can configure them
 - All nodes need the same username (often `ubuntu` but can be anything)

## k8smaker_config
Edit this file to set your cluster name, username, etc.  This is shared across all the scripts.

## k8smaker_init
You run this on the `control-node1` to prep the machine, which configures apt, installs a few packages it needs to do the install like curl, docker, kubeadm, kubectl, kubelet, etc.  Several .yaml files are generated by this process and are dropping in the local directory before being applied, for your perusal.  A number of OS-level files are tweaked as well, but in an idempotent way.  Be aware, if you run this a second time, it **destroys any previous k8s cluster** and builds you a new one.  If you have any etcd data or docker volumes you want to preserve, copy them somewhere else first.

## k8smaker_addworker
You run this on the `control-node1`, passing it the hostname of the worker node to be added to the cluster.  It generates a Bash script into the local directory with the hostname embedded in it, copies an ssh key to the remote machine, then remote executes the script on that hostname.  This gives you complete visibility on what it's running.
